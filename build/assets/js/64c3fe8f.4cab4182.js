"use strict";(self.webpackChunkstatsig_docs=self.webpackChunkstatsig_docs||[]).push([[97002],{74834:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>d});var s=n(74848),i=n(28453);const a={title:"Cloudflare KV",keywords:["owner:brock"],last_update:{date:new Date("2025-09-18T00:00:00.000Z")}},r=void 0,o={id:"integrations/cloudflare",title:"Cloudflare KV",description:"Overview",source:"@site/docs/integrations/cloudflare.md",sourceDirName:"integrations",slug:"/integrations/cloudflare",permalink:"/integrations/cloudflare",draft:!1,unlisted:!1,editUrl:"https://github.com/statsig-io/docs/edit/main/docs/integrations/cloudflare.md",tags:[],version:"current",lastUpdatedAt:17581536e5,frontMatter:{title:"Cloudflare KV",keywords:["owner:brock"],last_update:{date:"2025-09-18T00:00:00.000Z"}},sidebar:"cloud",previous:{title:"Vercel",permalink:"/integrations/vercel"},next:{title:"Cloudflare Workers AI",permalink:"/integrations/workersai"}},l={},d=[{value:"Overview",id:"overview",level:2},{value:"Configure Integration",id:"configure-integration",level:2},{value:"Add the Statsig SDK to your Worker",id:"add-the-statsig-sdk-to-your-worker",level:2},{value:"1. The <code>CloudflareKVDataAdapter</code>",id:"1-the-cloudflarekvdataadapter",level:3},{value:"2. SDK Initialization",id:"2-sdk-initialization",level:3},{value:"3. Checking a Gate",id:"3-checking-a-gate",level:3},{value:"4. Flushing Events",id:"4-flushing-events",level:3},{value:"Putting it all together",id:"putting-it-all-together",level:3},{value:"Other Considerations",id:"other-considerations",level:2},{value:"Polling for updates",id:"polling-for-updates",level:3},{value:"Flushing events",id:"flushing-events",level:3},{value:"Size Limits",id:"size-limits",level:3},{value:"Unsupported Features",id:"unsupported-features",level:3}];function c(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(t.p,{children:"Statsig\u2019s Cloudflare integration pushes Statsig Configs to Cloudflare KV, providing low latency for gate and experiment evaluations in Cloudflare Workers."}),"\n",(0,s.jsx)(t.h2,{id:"configure-integration",children:"Configure Integration"}),"\n",(0,s.jsx)(t.p,{children:"First, enable the Cloudflare integration in the Statsig Console."}),"\n",(0,s.jsxs)(t.p,{children:["Navigate to ",(0,s.jsx)(t.a,{href:"https://console.statsig.com/integrations",children:"Project Settings -> Integrations"}),", and then select Cloudflare"]}),"\n",(0,s.jsx)(t.p,{children:"You will need to input the following:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Cloudflare Account ID"}),": Can be found in Cloudflare portal under ",(0,s.jsx)(t.strong,{children:"Account Home"})," -> ",(0,s.jsx)(t.strong,{children:"Workers"}),", on the right hand side"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"KV Namespace ID"}),": We recommend creating a new KV namespace for your Statsig integration. You can create a new namespace, and get the ID from ",(0,s.jsx)(t.strong,{children:"Account Home"})," -> ",(0,s.jsx)(t.strong,{children:"Storage and Databases"})," -> ",(0,s.jsx)(t.strong,{children:"KV"}),", and copy it from the table view."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Cloudflare API Key"}),": Can be found in Cloudflare portal under ",(0,s.jsx)(t.strong,{children:"Account Home"})," -> ",(0,s.jsx)(t.strong,{children:"Profile"})," -> ",(0,s.jsx)(t.strong,{children:"API Tokens"}),". We need a token with Account.Workers KV Storage Edit Permissions."]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"There is also an option to filter the configs that are synced into your KV namespace by a [/sdk-keys/target-apps](Target App).  You may wish to enable this in the future as the size of your config payload grows.  For now, you can leave this unchecked."}),"\n",(0,s.jsxs)(t.p,{children:["After filling this out, click ",(0,s.jsx)(t.strong,{children:"Enable"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["Within a minute, the Statsig backend should generate a config payload from your statsig project and push it into your KV namespace.  Under your KV namespace, navigate to ",(0,s.jsx)(t.strong,{children:"KV Pairs"})," - you should see an entry starting with the prefix ",(0,s.jsx)(t.code,{children:"statsig-"}),".  The next part of that is your project ID.  Copy that to the clipboard - you'll need it later."]}),"\n",(0,s.jsx)(t.h2,{id:"add-the-statsig-sdk-to-your-worker",children:"Add the Statsig SDK to your Worker"}),"\n",(0,s.jsxs)(t.p,{children:["Now lets hook up the SDK to read that config payload and use it for gate and experiment checks in your worker.  If you've never created a worker before, you can follow the instructions ",(0,s.jsx)(t.a,{href:"https://developers.cloudflare.com/workers/",children:"here"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["The remainder of this document assumes you are using nodejs.  If you are using another language, see the sdk language specific documentation for how to apply the implementation to that language.  You may need to implement a custom data adapter for your language -  we currently only offer the ",(0,s.jsx)(t.code,{children:"statsig-node-cloudflare-kv"})," package in node."]}),"\n",(0,s.jsx)(t.p,{children:"First up, you'll need to install the statsig sdk and the cloudflare kv data adapter."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"npm install statsig-node statsig-node-cloudflare-kv\n"})}),"\n",(0,s.jsx)(t.p,{children:"Then, you need to hook it all up.  This involves:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["Creating a new ",(0,s.jsx)(t.code,{children:"CloudflareKVDataAdapter"})," with the namespace you set up previously and your statsig project id"]}),"\n",(0,s.jsx)(t.li,{children:"Initializing the statsig sdk with the DataAdapter"}),"\n",(0,s.jsx)(t.li,{children:"Checking a Gate"}),"\n",(0,s.jsx)(t.li,{children:"Flushing events to statsig"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"If you've used a statsig sdk in the past, step 2 should be familiar, though you'll be telling the sdk to initialize from the KV store instead of from the statsig backend."}),"\n",(0,s.jsx)(t.p,{children:'In our example, we are checking a gate called "test_cloudflare_sync" that is set to pass for 50% of everyone.  We create a random userID on every request, and we should see it evaluate to true 50% of the time.'}),"\n",(0,s.jsxs)(t.h3,{id:"1-the-cloudflarekvdataadapter",children:["1. The ",(0,s.jsx)(t.code,{children:"CloudflareKVDataAdapter"})]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"const dataAdapter = new CloudflareKVDataAdapter(env.STATSIG_KV, 'statsig-YOUR_COMPANY_ID');\n"})}),"\n",(0,s.jsx)(t.p,{children:"The adapter takes two arguments:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["The KV namespace you set up previously.  This must be accessible and ",(0,s.jsx)(t.a,{href:"https://developers.cloudflare.com/kv/concepts/kv-bindings/",children:"configured as a binding for the worker"})]}),"\n",(0,s.jsxs)(t.li,{children:["Your statsig project id.  This is the string that comes after ",(0,s.jsx)(t.code,{children:"statsig-"})," in the KV namespace prefix.  You can also find it in any url when you are on the Statsig Console.  For example, ",(0,s.jsx)(t.code,{children:"https://console.statsig.com/7LhuarZImmfNdtl9IsDJeX/gates/test_cloudflare_sync/diagnostics"})," has a project ID of ",(0,s.jsx)(t.code,{children:"7LhuarZImmfNdtl9IsDJeX"})]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"2-sdk-initialization",children:"2. SDK Initialization"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"const res = await statsig.initialize(\n    env.STATSIG_SECRET_KEY,\n    { \n      dataAdapter: dataAdapter,\n      postLogsRetryLimit: 0,\n      initStrategyForIDLists: 'none',\n      initStrategyForIP3Country: 'none',\n      disableIdListsSync: true,\n      disableRulesetsSync: true,\n    },\n);\n"})}),"\n",(0,s.jsx)(t.p,{children:"SDK initialization takes two arguments:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Your statsig secret key.  This is available from the ",(0,s.jsx)(t.a,{href:"https://console.statsig.com/api_keys",children:"Project Settings"})," page in the Statsig Console.  This is used to authenticate your requests to the statsig backend.  In this example, we've configured it as an environment variable (set this in the cloudflare dashboard under Worker > Settings > Variables and Secrets)"]}),"\n",(0,s.jsxs)(t.li,{children:["An options object.  We are using the ",(0,s.jsx)(t.code,{children:"dataAdapter"})," property to hook up the Cloudflare KV store to the SDK. We're also disabling the ID list sync to speed up initialization"]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"3-checking-a-gate",children:"3. Checking a Gate"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:'const result = statsig.checkGateSync(\n  {\n    userID: String(randomIntFromInterval(1, 10000000)),\n  },\n  "test_cloudflare_sync",\n);\n'})}),"\n",(0,s.jsxs)(t.p,{children:["This is a gate check in code.  The first parameter is the ",(0,s.jsx)(t.code,{children:"StatsigUser"})," object you are checking, and the second is the gate name.  Refer to the ",(0,s.jsx)(t.a,{href:"/server/nodejsServerSDK",children:"node sdk documentation"})," for how to check other entities like experiments and dynamic configs.  Here, we have created a user with a random userID for every evaluation to illustrate a gate with a partial rollout working."]}),"\n",(0,s.jsx)(t.h3,{id:"4-flushing-events",children:"4. Flushing Events"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"ctx.waitUntil(statsig.flush(1000));\n"})}),"\n",(0,s.jsx)(t.p,{children:"This flushes all events from the sdk to statsig.  Without this, you wont be able to get diagnostic information in the Statsig Console, nor any event data you logged. We also set a 1s timeout to ensure the flush wont block the response."}),"\n",(0,s.jsx)(t.h3,{id:"putting-it-all-together",children:"Putting it all together"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"import { CloudflareKVDataAdapter } from 'statsig-node-cloudflare-kv';\nimport statsig from 'statsig-node';\n\nexport default {\n  async fetch(request, env, ctx) {\n    const dataAdapter = new CloudflareKVDataAdapter(env.STATSIG_KV, 'statsig-YOUR_COMPANY_ID');\n    const res = await statsig.initialize(\n      env.STATSIG_SECRET_KEY,\n      { \n        dataAdapter: dataAdapter,\n        postLogsRetryLimit: 0,\n        initStrategyForIDLists: 'none',\n        initStrategyForIP3Country: 'none',\n        disableIdListsSync: true,\n        disableRulesetsSync: true,\n    },\n    );\n\n    const result = statsig.checkGateSync(\n      {\n        userID: String(randomIntFromInterval(1, 10000000)),\n      },\n      \"test_cloudflare_sync\",\n    );\n    ctx.waitUntil(statsig.flush(1000));\n    return new Response('Hello World! + ' + JSON.stringify(result));\n  },\n};\n\nfunction randomIntFromInterval(min, max) { // min and max included \n  return Math.floor(Math.random() * (max - min + 1) + min);\n}\n"})}),"\n",(0,s.jsx)(t.p,{children:"If you want to check on the evaluations you are getting, you can go to the gate you created for this example and look at the evaluations in the Diagnostics tab."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:"https://github.com/user-attachments/assets/1cc865ed-e15c-41a4-8979-24e1d457a7b1",alt:"Diagnostics Stream"})}),"\n",(0,s.jsx)(t.p,{children:"And there you have it - a working Cloudflare KV integration for Statsig."}),"\n",(0,s.jsx)(t.h2,{id:"other-considerations",children:"Other Considerations"}),"\n",(0,s.jsx)(t.h3,{id:"polling-for-updates",children:"Polling for updates"}),"\n",(0,s.jsxs)(t.p,{children:["The SDK cannot poll for updates across requests since ",(0,s.jsx)(t.a,{href:"https://developers.cloudflare.com/workers/reference/security-model/#step-1-disallow-timers-and-multi-threading",children:"Cloudflare does not allow for timers**"}),".\nTo solve for this, a manual sync API is available for independently updating the SDK internal store."]}),"\n",(0,s.jsx)(t.p,{children:"For example, you could persist the last time you synced, and define an interval with which you are okay using a potentially stale config.  There is a tradeoff here between the frequency with which your integration will make an external request to update the config, and the likelihood that your evaluation results are up to date."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"if (env.lastSyncTime < Date.now() - env.syncInterval) {\n  env.lastSyncTime = Date.now();\n  context.waitUntil(statsig.syncConfigSpecs());\n}\n"})}),"\n",(0,s.jsx)(t.h3,{id:"flushing-events",children:"Flushing events"}),"\n",(0,s.jsx)(t.p,{children:"The SDK enqueues logged events and flushes them in batches. In order to ensure events are properly flushed, we recommend calling flush using context.waitUntil. This will keep the request handler alive until events are flushed without blocking the response."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"context.waitUntil(statsig.flush());\n"})}),"\n",(0,s.jsx)(t.h3,{id:"size-limits",children:"Size Limits"}),"\n",(0,s.jsxs)(t.p,{children:["Cloudflare KV has maximum size limits that may prevent Statsig from pushing configs into your KV. See ",(0,s.jsx)(t.a,{href:"https://developers.cloudflare.com/workers/platform/limits/#kv-limits",children:"here"})," for the latest Cloudflare KV limits.  If your payload continues to grow, you will need to set the option to filter the payload by a [/sdk-keys/target-apps](Target App) in the integration settings."]}),"\n",(0,s.jsx)(t.h3,{id:"unsupported-features",children:"Unsupported Features"}),"\n",(0,s.jsx)(t.p,{children:"Statsig ID Lists are not currently synced into Cloudflare KVs.  If you rely on large (>1000) ID lists, you will not be able to check them in your Cloudflare Worker."})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>o});var s=n(96540);const i={},a=s.createContext(i);function r(e){const t=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(a.Provider,{value:t},e.children)}}}]);