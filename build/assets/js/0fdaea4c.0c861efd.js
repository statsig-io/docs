"use strict";(self.webpackChunkstatsig_docs=self.webpackChunkstatsig_docs||[]).push([[18477],{80879:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>d});var i=n(74848),s=n(28453);const o={sidebar_label:"CDN Edge Testing",title:"CDN Edge Testing for Cached Resources",keywords:["owner:brock"],last_update:{date:new Date("2025-09-18T00:00:00.000Z")}},a=void 0,r={id:"guides/cdn-edge-testing",title:"CDN Edge Testing for Cached Resources",description:"Background",source:"@site/docs/guides/cdn-edge-testing.mdx",sourceDirName:"guides",slug:"/guides/cdn-edge-testing",permalink:"/guides/cdn-edge-testing",draft:!1,unlisted:!1,editUrl:"https://github.com/statsig-io/docs/edit/main/docs/guides/cdn-edge-testing.mdx",tags:[],version:"current",lastUpdatedAt:17581536e5,frontMatter:{sidebar_label:"CDN Edge Testing",title:"CDN Edge Testing for Cached Resources",keywords:["owner:brock"],last_update:{date:"2025-09-18T00:00:00.000Z"}},sidebar:"cloud",previous:{title:"Serverless",permalink:"/guides/serverless"},next:{title:"Vercel",permalink:"/integrations/vercel"}},l={},d=[{value:"Background",id:"background",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Cloudflare Implementation",id:"cloudflare-implementation",level:2},{value:"Fastly Implementation",id:"fastly-implementation",level:2},{value:"KV (fully supported)",id:"kv-fully-supported",level:3},{value:"ConfigStore (not recommended)",id:"configstore-not-recommended",level:3},{value:"Recommended pattern",id:"recommended-pattern",level:3},{value:"Fastly VCL Implementation",id:"fastly-vcl-implementation",level:3},{value:"AWS Implementation",id:"aws-implementation",level:2},{value:"Lambda@Edge Implementation",id:"lambdaedge-implementation",level:3},{value:"Viewer Request function",id:"viewer-request-function",level:4},{value:"Viewer Response function",id:"viewer-response-function",level:4},{value:"CloudFront Functions Implementation",id:"cloudfront-functions-implementation",level:3},{value:"Akamai Implementation",id:"akamai-implementation",level:2}];function c(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.h2,{id:"background",children:"Background"}),"\n",(0,i.jsxs)(t.p,{children:["Most customers with heavy web traffic use a CDN to serve resources from cache, in order to minimize hit to their web servers. This has historically made testing challenging because you don\u2019t have the luxury of calling the SDK for all requests \u2014 but now with the emergence of Edge compute (offered by ",(0,i.jsx)(t.em,{children:"most providers"}),"), customers can now run code at their CDN edge, allowing them to assign users to tests and determine which resources to serve in a convenient and performant way.\nThis pattern is optimal for testing with cached content without sacrificing cache-hit ratio. For scenarios where running the Statsig SDK at the edge is not possible, the sdk must be implemented on the origin server, or you should consider using a client SDK."]}),"\n",(0,i.jsx)("figure",{children:(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.img,{alt:"architecture",src:n(33438).A+"",width:"2016",height:"636"}),"\n",(0,i.jsx)("figcaption",{children:(0,i.jsx)(t.em,{children:(0,i.jsx)(t.em,{children:"example only \u2014 implementation may vary depending on your provider"})})})]})}),"\n",(0,i.jsx)(t.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:['Use a provider-specific "Config Sync" ',(0,i.jsx)(t.a,{href:"https://console.statsig.com/integrations",children:"integration"})," \u2014 Statsig will automatically sync your Statsig configuration data to your provider's Edge Storage."]}),"\n",(0,i.jsx)(t.li,{children:"Use a provider-specific Data Adapter \u2014 This will allow the Statsig SDK to initialize using the configuration stored at the edge near your function. Links for each provider provided below."}),"\n",(0,i.jsxs)(t.li,{children:["Use ",(0,i.jsx)(t.a,{href:"https://www.npmjs.com/package/statsig-node-lite",children:"statsig-node-lite"})," \u2014 This is a slimmed down version of the Node SDK, which includes only the essentials and dramatically improves initialization performance for cold-starts requests."]}),"\n",(0,i.jsx)(t.li,{children:"Persist a uuid \u2014 As always, you'll need some sort of user identifier that can be used to consistently assign a user to your test buckets. This can typically be solved by generating a uuid in your function and setting it to a cookie."}),"\n",(0,i.jsx)(t.li,{children:"Persist assignments in a cookie \u2014 Some customers will set assignments to a cookie for the purpose of a performance optimization, allowing your code to skip sdk calls if the user is already assigned to a test. This is best defined as a session-cookie (a cookie that expires when user closes their browser)."}),"\n",(0,i.jsxs)(t.li,{children:["Persist client instance \u2014 ",(0,i.jsx)(t.a,{href:"/guides/serverless#usage",children:"This pattern"})," allows the Statsig client instance to persists across requests when the edge function remains warm and will improve performance."]}),"\n",(0,i.jsxs)(t.li,{children:["Use ",(0,i.jsx)(t.a,{href:"/sdk-keys/target-apps",children:"Target Apps"}),' \u2014 Target apps will allow you to sync a specific subset of experiments/gates to your edge function, reducing the footprint of your project config and improving performance. Target Apps are compatible with all of the "config sync" integrations.']}),"\n",(0,i.jsxs)(t.li,{children:["Consider ",(0,i.jsx)(t.a,{href:"https://github.com/statsig-io/node-js-lite-server-sdk/blob/d88aab788a16d0d38adf851e67c21bb846f12d24/src/index.ts#L191",children:"peaking at experiment assignments"})," and avoid logging exposures. You should only log exposure events once a user has been exposed to the treatment, otherwise your test results may become polluted with users that didn't see the treatment.","\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["You should consider how this can be managed downstream in your application. All SDKs have a means of tracking exposures manually, and you can also consider using the ",(0,i.jsx)(t.a,{href:"/http-api#log-exposure-event",children:"HTTP API for logging exposures"}),"."]}),"\n",(0,i.jsxs)(t.li,{children:["If you choose to log exposures from your edge function, you should consider using the ",(0,i.jsx)(t.code,{children:"context.waitUntil"})," method if supported by your edge provider (",(0,i.jsx)(t.a,{href:"/server/nodejsServerSDK#environment-specific-setup",children:"examples"}),")."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"cloudflare-implementation",children:"Cloudflare Implementation"}),"\n",(0,i.jsx)(t.p,{children:"Cloudflare allows its users to easily stand up a serverless edge worker that will get invoked prior to cache lookup and also allow you to modify the response to the viewer. The Worker architecture gives you full code control over how you'd like to map test assignments to resources you should serve to the user, allow you to modify both the URL (serving as cache-key) and headers used to fetch your resource from the CDN, passing the modified request through to origin on cache-miss."}),"\n",(0,i.jsxs)(t.p,{children:["The Cloudflare Worker runtime allows you to install ",(0,i.jsx)(t.a,{href:"https://github.com/statsig-io/node-js-lite-server-sdk",children:"Statsig Node Lite SDK"})," as a dependency and use it to determine test assignment to determine how to fetch a given resource."]}),"\n",(0,i.jsxs)(t.p,{children:["We offer both an ",(0,i.jsx)(t.a,{href:"/integrations/cloudflare",children:"integration with Cloudflare KV"}),", and a pre-built ",(0,i.jsx)(t.a,{href:"https://github.com/statsig-io/cloudflare-data-adapter-node/tree/master",children:"KV Data Adapter"}),", ensuring that SDK initialization is performant and doesn't depend on requests over the network back to Statsig."]}),"\n","\n",(0,i.jsx)(t.h2,{id:"fastly-implementation",children:"Fastly Implementation"}),"\n",(0,i.jsx)(t.p,{children:"Fastly Compute platform supports Functions at the Edge, affording customers the ability to handle assignment at the edge."}),"\n",(0,i.jsx)(t.h3,{id:"kv-fully-supported",children:"KV (fully supported)"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://www.fastly.com/blog/be-among-the-first-to-try-the-greatest-kv-store-ever-made",children:"Fastly's KV storage solution"})," is touted as being highly-performant and is now their recommended solution over their legacy ConfigStore documented below."]}),"\n",(0,i.jsxs)(t.p,{children:["Statsig offers both a Config-Sync for Fastly KV as well as a KV DataAdapter which can be found ",(0,i.jsx)(t.a,{href:"/integrations/fastly",children:"here"}),"."]}),"\n",(0,i.jsx)(t.h3,{id:"configstore-not-recommended",children:"ConfigStore (not recommended)"}),"\n",(0,i.jsxs)(t.p,{children:["We initially built the ",(0,i.jsx)(t.a,{href:"/integrations/fastly",children:"integration with Fastly's ConfigStore"}),", which was their only offering at the time. ConfigStore values are limited to 8 kilobytes, which will be met rather quickly as the number of gates and tests in your project increases.  This will be paired with our ",(0,i.jsx)(t.a,{href:"https://www.npmjs.com/package/statsig-node-fastly",children:"Fastly Config Store Data Adapter"}),", allow the SDK to initialize from ConfigStore rather than making a request over the the network back to Statsig."]}),"\n",(0,i.jsx)(t.h3,{id:"recommended-pattern",children:"Recommended pattern"}),"\n",(0,i.jsxs)(t.p,{children:["The Fastly pattern is a bit different than some of the other providers \u2014 as recommended by ",(0,i.jsx)(t.a,{href:"https://www.fastly.com/documentation/solutions/tutorials/ab-testing-edge-compute/#use-the-allocations-on-your-origin-server",children:"the Fastly AB Testing guide"}),", it does not involve modifying the cache-key (resource URL), but instead attaching ",(0,i.jsx)(t.code,{children:"Fastly-ABTest-<TEST ID>"})," headers, which will tell your origin server how to render the resource, and the origin response should include a ",(0,i.jsx)(t.code,{children:"Vary"})," response header to tell Fastly CDN  what to cache. This approach is documented thoroughly by Fastly, and it's recommended that their guide serves as the source of truth for the design pattern."]}),"\n",(0,i.jsxs)(t.admonition,{type:"info",children:[(0,i.jsx)(t.h3,{id:"fastly-vcl-implementation",children:"Fastly VCL Implementation"}),(0,i.jsx)(t.p,{children:"Their legacy Varnish-based platform only supports configuration based caching and minimal scripting at the edge using VCL scripting language."}),(0,i.jsx)(t.p,{children:"Practically speaking, there is no Statsig SDK (or any SDK for that matter) support at the edge for this reason. In this instance, the Statsig SDK must be implemented on the origin server, and cache rules must be configured to force a cache-miss and allow assignments to take place on the origin server."})]}),"\n",(0,i.jsx)(t.h2,{id:"aws-implementation",children:"AWS Implementation"}),"\n",(0,i.jsx)(t.p,{children:"AWS has a variety of serverless solutions, below we will detail the recommended pattern and various limitations associated with each."}),"\n",(0,i.jsx)(t.h3,{id:"lambdaedge-implementation",children:"Lambda@Edge Implementation"}),"\n",(0,i.jsx)(t.p,{children:"Lambda@Edge are Lambda functions that are designed to be triggered by CloudFront events.\nLambda@Edge implementations carry a few unique challenges:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["At the time of writing this, AWS does not offer a KV store solution compatible with Lambda@Edge. Their ",(0,i.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/kvs-with-functions.html",children:"KeyValueStore"})," offering is only compatible with Cloudfront Functions. This means, you will either have to:","\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Use the default Statsig SDK initialization, which will incur a hit over the network to Statsig to load configurations"}),"\n",(0,i.jsxs)(t.li,{children:["Bundle your project config statically into the function package. You can consider using our ",(0,i.jsx)(t.a,{href:"/integrations/event_webhook#config-change-webhooks",children:"Config-Change Webhook"})," to automate this. You'll need to download the configuration JSON at the following URL in order to bundle it into your Lambda package:  ",(0,i.jsx)(t.a,{href:"https://api.statsigcdn.com/v1/download_config_specs/SERVER_SDK_KEY.json",children:"https://api.statsigcdn.com/v1/download_config_specs/SERVER_SDK_KEY.json"})]}),"\n",(0,i.jsx)(t.li,{children:"Store your project config in S3 and use Cloudfront as means to serve it optimally when fetching it from your Lambda@Edge function."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.li,{children:"Function size is capped at 1MB in package size (for viewer request and viewer response triggers, which is what is required for this setup)."}),"\n",(0,i.jsxs)(t.li,{children:["Lambda model uses ",(0,i.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-cloudfront-trigger-events.html",children:"four events triggers"}),", calling your function at various stages of the request lifecycle. For this use case, you\u2019ll need to use two: ",(0,i.jsx)(t.code,{children:"Viewer Request"})," and ",(0,i.jsx)(t.code,{children:"View Response"}),". AWS provides documentation on how requests can be handled and manipulated ",(0,i.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/lambda-at-the-edge.html",children:"here"}),"."]}),"\n"]}),"\n",(0,i.jsx)(t.h4,{id:"viewer-request-function",children:"Viewer Request function"}),"\n",(0,i.jsxs)(t.p,{children:["Viewer Request will be called before cache lookup, and will be used to define a uuid, generate test assignment and modify the request URL via ",(0,i.jsx)(t.code,{children:"Request.URI"}),". This type of function cannot modify response headers, so you must pass any assignment and uuid info through to the Viewer Response function in order to set cookies. Event structure for each event documented here."]}),"\n",(0,i.jsx)(t.h4,{id:"viewer-response-function",children:"Viewer Response function"}),"\n",(0,i.jsx)(t.p,{children:"Viewer Response function is responsible only for setting uuid and assignment cookies as needed."}),"\n",(0,i.jsx)(t.h3,{id:"cloudfront-functions-implementation",children:"CloudFront Functions Implementation"}),"\n",(0,i.jsx)(t.p,{children:"SDKs are not supported here. Cloudfront Functions have 1ms max runtime and 10KB max function size. You\u2019ll have to use Lambda@Edge, or consider incurring Cache-misses to do assignment at origin."}),"\n",(0,i.jsx)(t.h2,{id:"akamai-implementation",children:"Akamai Implementation"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://www.akamai.com/blog/developers/better-a-b-testing-with-edgeworkes-edgekv",children:"Akamai has a documented pattern"}),"\xa0of using EdgeWorkers and EdgeKV for running AB tests using cached content, providing both code samples, as well as an overview of the ",(0,i.jsx)(t.a,{href:"https://www.akamai.com/solutions/edge/serverless-computing/use-cases",children:"architecture"}),". You\u2019ll need to add the Statsig SDK to the worker function as a dependency and call it for assignment (rather than the rudimentary coin flip using ",(0,i.jsx)(t.code,{children:"Math.random()"})," shown in their code examples)."]}),"\n",(0,i.jsxs)(t.p,{children:["You can now use our ",(0,i.jsx)(t.a,{href:"/integrations/akamai",children:"Akamai Edge integration"}),", which includes an integration with EdgeKV as well as a Node package that has been tested and validated within Akamai edge runtime."]})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},33438:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/edgefcn-0a79bc568c5b8050d2baaa176bbc0cbf.png"},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>r});var i=n(96540);const s={},o=i.createContext(s);function a(e){const t=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(o.Provider,{value:t},e.children)}}}]);