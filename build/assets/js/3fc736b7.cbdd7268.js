"use strict";(self.webpackChunkstatsig_docs=self.webpackChunkstatsig_docs||[]).push([[73732],{94464:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>a,metadata:()=>o,toc:()=>d});var s=n(74848),i=n(28453);const a={title:"Fastly",keywords:["owner:brock"],last_update:{date:new Date("2025-09-25T00:00:00.000Z")}},r=void 0,o={id:"integrations/fastly",title:"Fastly",description:"Overview",source:"@site/docs/integrations/fastly.md",sourceDirName:"integrations",slug:"/integrations/fastly",permalink:"/integrations/fastly",draft:!1,unlisted:!1,editUrl:"https://github.com/statsig-io/docs/edit/main/docs/integrations/fastly.md",tags:[],version:"current",lastUpdatedAt:17587584e5,frontMatter:{title:"Fastly",keywords:["owner:brock"],last_update:{date:"2025-09-25T00:00:00.000Z"}},sidebar:"cloud",previous:{title:"Cloudflare Workers AI",permalink:"/integrations/workersai"},next:{title:"Akamai Edge KV",permalink:"/integrations/akamai"}},l={},d=[{value:"Overview",id:"overview",level:2},{value:"Configure Integration",id:"configure-integration",level:2},{value:"Add the Statsig SDK to your Worker",id:"add-the-statsig-sdk-to-your-worker",level:2},{value:"Imports",id:"imports",level:3},{value:"1. The <code>FastlyDataAdapter</code>",id:"1-the-fastlydataadapter",level:3},{value:"2. SDK Initialization",id:"2-sdk-initialization",level:3},{value:"3. Checking a Gate",id:"3-checking-a-gate",level:3},{value:"4. Flushing Events",id:"4-flushing-events",level:3},{value:"Putting it all together",id:"putting-it-all-together",level:3},{value:"Other Considerations",id:"other-considerations",level:2},{value:"Polling for updates v5.13.0+",id:"polling-for-updates-v5130",level:3},{value:"Flushing events v4.16.0+",id:"flushing-events-v4160",level:3},{value:"Size Limits",id:"size-limits",level:3},{value:"Unsupported Features",id:"unsupported-features",level:3}];function h(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(t.p,{children:"Statsig\u2019s Fastly integration pushes Statsig Configs to Fastly KV, providing low latency for gate and experiment evaluations in your Fastly project."}),"\n",(0,s.jsx)(t.h2,{id:"configure-integration",children:"Configure Integration"}),"\n",(0,s.jsx)(t.p,{children:"First, enable the Fastly integration in the Statsig Console."}),"\n",(0,s.jsxs)(t.p,{children:["Navigate to ",(0,s.jsx)(t.a,{href:"https://console.statsig.com/integrations",children:"Project Settings -> Integrations"}),", and then select Fastly"]}),"\n",(0,s.jsx)(t.p,{children:"You will need to input the following:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Fastly API Key"})," - Can be found in Fastly portal under ",(0,s.jsx)(t.strong,{children:"Account"})," -> ",(0,s.jsx)(t.strong,{children:"API Tokens"}),'. We need an "Automation token" with "Engineer Roles" and the following scopes: "global" and "global',":read",'"']}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Store Type"}),' - Select "KV Store"']}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"KV Store ID"}),"- You can create a new KV Store for this integration, or reuse an existing one"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"There is also an option to filter the configs that are synced into your KV namespace by a [/sdk-keys/target-apps](Target App).  You may wish to enable this in the future as the size of your config payload grows.  For now, you can leave this unchecked."}),"\n",(0,s.jsxs)(t.p,{children:["After filling this out, click ",(0,s.jsx)(t.strong,{children:"Enable"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["Within a minute, the Statsig backend should generate a config payload from your statsig project and push it into your store.  Under your KV Store, look for a key starting with the prefix ",(0,s.jsx)(t.code,{children:"statsig-"}),".  This is the key to your statsig config specs in the Fastly KV store."]}),"\n",(0,s.jsx)(t.h2,{id:"add-the-statsig-sdk-to-your-worker",children:"Add the Statsig SDK to your Worker"}),"\n",(0,s.jsx)(t.p,{children:"Now lets hook up the SDK to read that config payload and use it for gate and experiment checks in your fastly compute."}),"\n",(0,s.jsxs)(t.p,{children:["The remainder of this document assumes you are using Node.js.  If you are using another language, see the sdk language specific documentation for how to apply the implementation to that language.  You may need to implement a custom data adapter for your language -  we currently only offer the ",(0,s.jsx)(t.code,{children:"statsig-node-fastly-kv"})," package in node. This data adapter will work out of the box for statsig usage in the fastly/js-compute runtime. Note this data adapter currently only supports Fastly KV store."]}),"\n",(0,s.jsxs)(t.p,{children:["First up, you'll need to install the statsig ",(0,s.jsx)(t.strong,{children:"node-lite"})," sdk and the fastly kv data adapter."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"npm install statsig-node-lite statsig-node-fastly-kv\n"})}),"\n",(0,s.jsx)(t.p,{children:"Then, you need to hook it all up.  This involves:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["Creating a new ",(0,s.jsx)(t.code,{children:"FastlyDataAdapter"})," with the namespace you set up previously and your statsig project id"]}),"\n",(0,s.jsx)(t.li,{children:"Initializing the statsig sdk with the DataAdapter"}),"\n",(0,s.jsx)(t.li,{children:"Checking a Gate"}),"\n",(0,s.jsx)(t.li,{children:"Flushing events to statsig"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"If you've used a statsig sdk in the past, step 2 should be familiar, though you'll be telling the sdk to initialize from the KV store instead of from the statsig backend."}),"\n",(0,s.jsx)(t.p,{children:'In our example, we are checking a gate called "test_fastly" that is set to pass for 50% of everyone.  We create a random userID on every request, and we should see it evaluate to true 50% of the time.'}),"\n",(0,s.jsx)(t.h3,{id:"imports",children:"Imports"}),"\n",(0,s.jsxs)(t.p,{children:["Import the statsig ",(0,s.jsx)(t.strong,{children:"node-lite"})," sdk and the statsig fastly kv adapter."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"import Statsig from 'statsig-node-lite';\nimport { FastlyDataAdapter } from 'statsig-node-fastly-kv';\n"})}),"\n",(0,s.jsxs)(t.h3,{id:"1-the-fastlydataadapter",children:["1. The ",(0,s.jsx)(t.code,{children:"FastlyDataAdapter"})]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"const dataAdapter = new FastlyDataAdapter(<YOUR_KV_STORE_NAME>, '<CONFIG_SPEC_KEY>');\n"})}),"\n",(0,s.jsx)(t.p,{children:"The adapter takes two arguments:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Your KV store name.","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Your KV store must be linked to your compute service. To do so, go to ",(0,s.jsx)(t.strong,{children:"KV STORES"})," -> ",(0,s.jsx)(t.strong,{children:"Your KV Store"})," -> ",(0,s.jsx)(t.strong,{children:"Linked Services"})," -> ",(0,s.jsx)(t.strong,{children:"Link Service"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.li,{children:'Your KV store item key. (Will begin with "statsig-************...")'}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"2-sdk-initialization",children:"2. SDK Initialization"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"await Statsig.initialize(\"secret-******************\", {\n      dataAdapter,\n      disableIdListsSync: true,\n      initStrategyForIDLists: 'none',\n    });\n"})}),"\n",(0,s.jsx)(t.p,{children:"SDK initialization takes two arguments:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Your statsig secret key.  This is available from the ",(0,s.jsx)(t.a,{href:"https://console.statsig.com/api_keys",children:"Project Settings"})," page in the Statsig Console.  This is used to authenticate your requests to the statsig backend.  In this example, we have hardcoded it for simplicity. In production environments, please protect your Statsig server key. Refer to this ",(0,s.jsx)(t.a,{href:"https://www.fastly.com/documentation/reference/compute/ecp-env/",children:"Fastly documentation"})," for using environment variables in the Compute Platform."]}),"\n",(0,s.jsxs)(t.li,{children:["An options object.  We are using the ",(0,s.jsx)(t.code,{children:"dataAdapter"})," property to hook up the Fastly KV store to the SDK.  We're also disabling the ID list sync to speed up initialization"]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"3-checking-a-gate",children:"3. Checking a Gate"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:'const result = Statsig.checkGateSync(\n  {\n    userID: String(randomIntFromInterval(1, 10000000)),\n  },\n  "test_fastly",\n);\n'})}),"\n",(0,s.jsxs)(t.p,{children:["This is a gate check in code.  The first parameter is the ",(0,s.jsx)(t.code,{children:"StatsigUser"})," object you are checking, and the second is the gate name.  Refer to the ",(0,s.jsx)(t.a,{href:"/server/nodejsServerSDK",children:"node sdk documentation"})," for how to check other entities like experiments and dynamic configs.  Here, we have created a user with a random userID for every evaluation to illustrate a gate with a partial rollout working."]}),"\n",(0,s.jsx)(t.h3,{id:"4-flushing-events",children:"4. Flushing Events"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"await Statsig.flush();\n"})}),"\n",(0,s.jsx)(t.p,{children:"This flushes all events from the sdk to statsig.  Without this, you wont be able to get diagnostic information in the Statsig Console, nor any event data you logged."}),"\n",(0,s.jsx)(t.h3,{id:"putting-it-all-together",children:"Putting it all together"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:'/// <reference types="@fastly/js-compute" />\nimport { FastlyDataAdapter } from \'statsig-node-fastly-kv\';\nimport Statsig from \'statsig-node-lite\';\n\naddEventListener("fetch", (event) => event.respondWith(handleRequest(event)));\n\nasync function handleRequest(event) {\n  try {\n    const dataAdapter = new FastlyDataAdapter(<YOUR_KV_NAME>, <CONFIG_SPEC_KEY>);\n\n    await Statsig.initialize("secret-**********************", {\n      dataAdapter,\n      disableIdListsSync: true,\n      initStrategyForIDLists: \'none\',\n    });\n\n    const userID = String(randomIntFromInterval(1, 10000000));\n\n    const result = Statsig.checkGateSync({\n      userID: String(randomIntFromInterval(1, 10000000)),\n    }, "test_fastly");\n\n    await Statsig.flush();\n\n    return new Response(JSON.stringify({\n      userID: userID,\n      gateResult: result\n    }), {\n      status: 200,\n      headers: new Headers({ "Content-Type": "application/json" }),\n    });\n\n  } catch (error) {\n    console.error(\'Error in handleRequest:\', error);\n    \n    return new Response(JSON.stringify({ \n      error: \'Internal server error\',\n      details: error.message \n    }), {\n      status: 500,\n      headers: new Headers({ "Content-Type": "application/json" }),\n    });\n  }\n}\n\nfunction randomIntFromInterval(min, max) {\n  return Math.floor(Math.random() * (max - min + 1) + min);\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:"If you want to check on the evaluations you are getting, you can go to the gate you created for this example and look at the evaluations in the Diagnostics tab."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:"https://github.com/user-attachments/assets/1cc865ed-e15c-41a4-8979-24e1d457a7b1",alt:"Diagnostics Stream"})}),"\n",(0,s.jsx)(t.p,{children:"And there you have it - a working Fastly KV integration for Statsig."}),"\n",(0,s.jsx)(t.h2,{id:"other-considerations",children:"Other Considerations"}),"\n",(0,s.jsx)(t.h3,{id:"polling-for-updates-v5130",children:"Polling for updates v5.13.0+"}),"\n",(0,s.jsx)(t.p,{children:"The SDK cannot poll for updates across requests since Fastly does not allow for timers.\nTo solve for this, a manual sync API is available for independently updating the SDK internal store."}),"\n",(0,s.jsx)(t.p,{children:"For example, you could persist the last time you synced, and define an interval with which you are okay using a potentially stale config.  There is a tradeoff here between the frequency with which your integration will make an external request to update the config, and the likelihood that your evaluation results are up to date."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"if (env.lastSyncTime < Date.now() - env.syncInterval) {\n  env.lastSyncTime = Date.now();\n  event.waitUntil(statsig.syncConfigSpecs());\n}\n"})}),"\n",(0,s.jsx)(t.h3,{id:"flushing-events-v4160",children:"Flushing events v4.16.0+"}),"\n",(0,s.jsx)(t.p,{children:"The SDK enqueues logged events and flushes them in batches. In order to ensure events are properly flushed, we recommend calling flush using event.waitUntil. This will keep the request handler alive until events are flushed without blocking the response."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"event.waitUntil(statsig.flush());\n"})}),"\n",(0,s.jsx)(t.h3,{id:"size-limits",children:"Size Limits"}),"\n",(0,s.jsxs)(t.p,{children:["Fastly Config Store has maximum size limits that may prevent Statsig from pushing configs into Fastly. See ",(0,s.jsx)(t.a,{href:"https://docs.fastly.com/products/edge-data-storage",children:"here"})," for the latest Config Store limits. If your payload continues to grow, you will need to set the option to filter the payload by a [/sdk-keys/target-apps](Target App) in the integration settings."]}),"\n",(0,s.jsx)(t.h3,{id:"unsupported-features",children:"Unsupported Features"}),"\n",(0,s.jsxs)(t.p,{children:["Statsig ID Lists are not currently synced into Fastly KVs or Config Stores.  If you rely on large (>1000) ID lists, you will not be able to check them in your Fastly compute services.  This is why we set ",(0,s.jsx)(t.code,{children:"initStrategyForIDLists: 'none'"})," in the SDK initialization."]})]})}function c(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>o});var s=n(96540);const i={},a=s.createContext(i);function r(e){const t=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(a.Provider,{value:t},e.children)}}}]);