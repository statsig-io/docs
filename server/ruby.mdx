---
title: Ruby Server SDK
sidebarTitle: Ruby
description: Statsig's Server SDK for Ruby applications
icon: "gem"
---

import CheckGateIntro from '/snippets/server/checkGate.mdx'
import GetDynamicConfigIntro from '/snippets/server/getDynamicConfig.mdx'
import GetExperimentIntro from '/snippets/server/getExperiment.mdx'
import LogEventIntro from '/snippets/server/logEvent.mdx'
import LogEventFooter from '/snippets/server/logEventFooter.mdx'
import GetFeatureGateIntro from '/snippets/server/getFeatureGate.mdx'
import StatsigUserIntro from '/snippets/server/statsigUser.mdx'
import PrivateAttributesIntro from '/snippets/server/privateAttributes.mdx'
import StatsigOptionsIntro from '/snippets/server/statsigOptions.mdx'
import ShutdownIntro from '/snippets/server/shutdown.mdx'
import ClientInitResponseIntro from '/snippets/server/clientInitResponse.mdx'
import ManualExposuresIntro from '/snippets/server/manualExposures.mdx'
import LocalOverridesIntro from '/snippets/server/localOverrides.mdx'
import PersistentStorageIntro from '/snippets/server/persistentStorage.mdx'
import MultiInstanceIntro from '/snippets/server/multiInstance.mdx'
import InitializationWarning from '/snippets/server/initialization.mdx'
import InitializationFooter from '/snippets/server/initialization2.mdx'

<Card title="GitHub Repository" icon="github" href="https://github.com/statsig-io/ruby-sdk">
  View the Ruby SDK source code and releases
</Card>

## Setup the SDK

<Steps>
<Step title="Install the SDK">

If you are using Bundler, add the [gem](https://rubygems.org/gems/statsig) to your Gemfile from command line:

```shell
bundle add statsig
```

or directly include it in your Gemfile and run `bundle install`:

```shell
gem "statsig", ">= X.Y.Z"
```

Check out the latest versions on [https://rubygems.org/gems/statsig](https://rubygems.org/gems/statsig)

</Step>
<Step title="Initialize the SDK">
<InitializationWarning/>

```ruby
require 'statsig'

Statsig.initialize('server-secret-key')
```


```ruby
# Or, if you want to initialize with certain options
options = StatsigOptions.new({'tier' => 'staging'}, network_timeout: 5)

# And a callback when the initialization network request fails
  def error_callback(e)
    puts e
  end


...
Statsig.initialize('server-secret-key', options, method(:error_callback))
```

### Initializing Statsig in a Rails Application

If your application is using Rails, you should initialize Statsig in `config/initializers/statsig.rb`:

```ruby
Statsig.initialize('server-secret-key', options)
```

### Initializing Statsig when using Unicorn, Puma, Passenger, or Sidekiq

For **Unicorn**, you should initialize Statsig within an `after_fork` hook in your `unicorn.rb` config file:

```ruby
after_fork do |server,worker|
  Statsig.initialize('server-secret-key', options)
end
```

For **Puma**, you should initialize Statsig within an `on_worker_boot` hook in your `puma.rb` config file:

```ruby
on_worker_boot do
  Statsig.initialize('server-secret-key', options)
end
```

For **Passenger**, you should initialize Statsig in your `config.ru` config file:

```ruby
if defined?(PhusionPassenger)
  PhusionPassenger.on_event(:starting_worker_process) do |forked|
    Statsig.initialize('server-secret-key', options)
  end
end
```

For **Sidekiq**, you should initialize Statsig in your `sidekiq.rb`/server configuration file:

```ruby
Sidekiq.configure_server do |config|
  config.on(:startup) do
    Statsig.initialize
  end

  config.on(:shutdown) do
    Statsig.shutdown
  end
end
```

If you are using Rails in combination with any of the above, you should be sure to initialize using the specific process lifecycle hooks exposed by the respective tool. You can initialize in multiple places, which should ensure the SDK is fully usable including all background processing.

<InitializationFooter/>
</Step>
</Steps>

## Working with the SDK

<CheckGateIntro/>

```ruby
user = StatsigUser.new({'userID' => 'some_user_id'})
if Statsig.check_gate(user, 'use_new_feature')
  # Gate is on, enable new feature
else
  # Gate is off
end
```

<GetDynamicConfigIntro/>

```ruby
config = Statsig.get_config(user, 'awesome_product_details')

# The 2nd parameter is the default value to be used in case the given parameter name does not exist on
# the Dynamic Config object. This can happen when there is a typo, or when the user is offline and the
# value has not been cached on the client.
item_name = config.get('product_name', 'Awesome Product v1');
price = config.get('price', 10.0);
shouldDiscount = config.get('discount', false);

# Or just get the whole json object backing this config if you prefer
json = config.value

```

<GetExperimentIntro/>

```ruby
# Values via getLayer

layer = Statsig.get_layer(user, "user_promo_experiments")
title = layer.get("title", "Welcome to Statsig!")
discount = layer.get("discount", 0.1)

# or, via getExperiment

title_exp = Statsig.get_experiment(user, "new_user_promo_title")
price_exp = Statsig.get_experiment(user, "new_user_promo_price")

title = title_exp.get("title", "Welcome to Statsig!")
discount = price_exp.get("discount", 0.1)

...

price = msrp * (1 - discount)


```

<LogEventIntro/>

```ruby
Statsig.log_event(
  user,
  'add_to_cart',
  'SKU_12345',
  {
    'price' => '9.99',
    'item_name' => 'diet_coke_48_pack'
  }
)
```

<LogEventFooter/>

<StatsigUserIntro/>
<PrivateAttributesIntro/>

<StatsigOptionsIntro/>

You can specify optional parameters with `options` when initializing.

- **environment**: Hash, default `nil`
  - a Hash you can use to set environment variables that apply to all of your users in the same session and will be used for targeting purposes.
  - The most common usage is to set the "tier" (string), and have feature gates pass/fail for specific environments. The accepted values are "production", "staging" and "development", e.g. `StatsigOptions.New({ 'tier' => 'staging' })`.
- **download_config_specs_url**: String, default `"https://api.statsigcdn.com/v2/download_config_specs/"`
  - The url used specifically to call download_config_specs
- **log_event_url**: String, default `"https://statsigapi.net/v1/log_event"`
  - The url used specifically to call log_event
- **get_id_lists_url**: String, default `"https://statsigapi.net/v1/get_id_lists"`
  - The url used specifically to call get_id_lists
- **rulesets_sync_interval**: Number, default `10`
  - The interval (in seconds) to poll for changes to your Statsig configuration
- **idlists_sync_interval**: Number, default `60`
  - The interval (in seconds) to poll for changes to id lists
- **disable_rulesets_sync**: Boolean, default `false`
  - Disable background syncing for rulesets
- **disable_idlists_sync**: Boolean, default `false`
  - Disable background syncing for id lists
- **logging_interval_seconds**: Number, default `60`
  - How often to flush logs to Statsig
- **logging_max_buffer_size**: Number, default `1000`, can be set lower but anything over 1000 will be dropped on the server
  - The maximum number of events to batch before flushing logs to the server
- **local_mode**: Boolean, default `false`
  - Restricts the SDK to not issue any network requests and only respond with default values (or local overrides)
- **bootstrap_values**: String, default `nil`
  - A string that represents all rules for all feature gates, dynamic configs and experiments. It can be provided to bootstrap the Statsig server SDK at initialization in case your server runs into network issue or Statsig server is down temporarily.
- **rules_updated_callback**: function, default `nil`
  - A callback function that will be called anytime the rulesets are updated
- **data_store**: IDataStore, default `nil`
  - A class that extends IDataStore. Can be used to provide values from a common data store (like Redis) to initialize the Statsig SDK.
- **idlist_threadpool_size**: Number, default `3`
  - The number of threads allocated to syncing IDLists
- **logger_threadpool_size**: Number, default `3`
  - The number of threads allocated to posting event logs
- **disable_diagnostics_logging**: Boolean, default `false`
  - Should diagnostics be logged. These include performance metrics for initialize
- **disable_sorbet_logging_handlers**: Boolean, default `false`
  - Statsig utilizes Sorbet (https://sorbet.org) to ensure type safety of the SDK. This includes logging to console when errors are detected. You can disable this logging by setting this flag to true.
- **network_timeout**: Number, default `nil`
  - Maximum number of seconds to wait for a network call before timing out
- **post_logs_retry_limit**: Number, default `3`
  - Number of times to retry sending a batch of failed log events
- **post_logs_retry_backoff**: Number/Function, default `nil`
  - The number of seconds, or a function that returns the number of seconds based on the number of retries remaining which overrides the default backoff time between retries
- **user_persistent_storage**: IUserPersistentStorage, default `nil`
  - A storage adapter for persisted values. Can be used for sticky bucketing users in experiments. Implements Statsig::Interfaces::IUserPersistentStorage.

<ShutdownIntro/>

```ruby
Statsig.shutdown
```

<ClientInitResponseIntro/>

```ruby
values = Statsig.get_client_initialize_response(user); # Hash[String, Any] | Nil
```

<LocalOverridesIntro/>

```ruby
# Adding gate overrides
Statsig.override_gate("a_gate_name", true)

# Adding config overrides
Statsig.override_config("a_config_name", {"key" => "value"})
```

<Note>
1. These only apply locally - they do not update definitions in the Statsig console or elsewhere.
2. The local override API is not designed to be a full mock. They are only a convenient way to override the value of the gate/config/etc.
</Note>

<ManualExposuresIntro/>

**Gates**

```ruby
result = Statsig.check_gate(user, 'a_gate_name', CheckGateOptions.new(disable_log_exposure: true))
```

```ruby
Statsig.manually_log_gate_exposure(user, 'a_gate_name')
```

**Configs**

```ruby
config = Statsig.get_config(user, 'a_dynamic_config_name', GetConfigOptions.new(disable_log_exposure: true))
```

```ruby
Statsig.manually_log_config_exposure(user, 'a_dynamic_config_name')
```

**Experiments**

```ruby
experiment = Statsig.get_experiment(user, 'an_experiment_name', GetExperimentOptions.new(disable_log_exposure: true))
```

```ruby
Statsig.manually_log_experiment_exposure(user, 'an_experiment_name')
```

**Layers**

```ruby
layer = Statsig.get_layer(user, 'a_layer_name', GetLayerOptions.new(disable_log_exposure: true))
paramValue = layer.get('a_param_name', 'fallback_value')
```

```ruby
Statsig.manually_log_layer_parameter_exposure(user, 'a_layer_name', 'a_param_name')
```

<PersistentStorageIntro/>

### Interface

```ruby
class IUserPersistentStorage
	def load(key)
		nil
	end

	def save(key, data) end
end
```

### Example Implementation

```ruby
class DummyPersistentStorageAdapter < Statsig::Interfaces::IUserPersistentStorage
  attr_accessor :store

  def initialize
    @store = {}
  end

  def load(key)
    return nil unless @store&.key?(key)

    @store[key]
  end

  def save(key, data)
    @store[key] = data
  end
end
```

<MultiInstanceIntro/>

```ruby
sdk_instance = StatsigDriver.new(secret_key, options, error_callback)
```

## FAQ

#### How do I run experiments for logged out users?

See the guide on [device level experiments](/guides/first-device-level-experiment)

#### How can I mock or override the SDK for testing?

Starting in `v1.12.0+`, the Ruby SDK supports `localMode` and `overrides`, see [Local Overrides](#local-overrides)

- `localMode` is a boolean parameter in `StatsigOptions` when initializing the SDK. It restricts all network traffic,
  so the SDK operates offline and only returns default or override values.

#### Can I generate the initialize response for a client SDK using the Ruby server SDK?

Yes. See [Client SDK Bootstrapping](#client-sdk-bootstrapping).

## Reference

### Type StatsigUser

```ruby
export type StatsigUser = {
class StatsigUser
  attr_accessor :user_id
  attr_accessor :email
  attr_accessor :ip
  attr_accessor :user_agent
  attr_accessor :country
  attr_accessor :locale
  attr_accessor :app_version
  attr_accessor :statsig_environment
  attr_accessor :custom_ids # Hash of key:string value:string
  attr_accessor :private_attributes # Hash of key:string value:string
  
  @custom # Hash of key:string value:string
  
  def initialize(user_hash)
    @statsig_environment = Hash.new
    if user_hash.is_a?(Hash)
      @user_id = user_hash['userID'] || user_hash['user_id']
      @user_id = @user_id.to_s unless @user_id.nil?
      @email = user_hash['email']
      @ip = user_hash['ip']
      @user_agent = user_hash['userAgent'] || user_hash['user_agent']
      @country = user_hash['country']
      @locale = user_hash['locale']
      @app_version = user_hash['appVersion'] || user_hash['app_version']
      @custom = user_hash['custom'] if user_hash['custom'].is_a? Hash
      @statsig_environment = user_hash['statsigEnvironment']
      @private_attributes = user_hash['privateAttributes'] if user_hash['privateAttributes'].is_a? Hash
      custom_ids = user_hash['customIDs'] || user_hash['custom_ids']
      @custom_ids = custom_ids if custom_ids.is_a? Hash
    end
  end
end
```

### Type StatsigOptions

```ruby
class StatsigOptions
  attr_accessor :environment
  attr_accessor :download_config_specs_url
  attr_accessor :log_event_url
  attr_accessor :get_id_lists_url
  attr_accessor :rulesets_sync_interval
  attr_accessor :idlists_sync_interval
  attr_accessor :disable_rulesets_sync
  attr_accessor :disable_idlists_sync
  attr_accessor :logging_interval_seconds
  attr_accessor :logging_max_buffer_size
  attr_accessor :local_mode
  attr_accessor :bootstrap_values
  attr_accessor :rules_updated_callback
  attr_accessor :data_store
  attr_accessor :idlist_threadpool_size
  attr_accessor :logger_threadpool_size
  attr_accessor :disable_diagnostics_logging
  attr_accessor :disable_sorbet_logging_handlers
  attr_accessor :network_timeout
  attr_accessor :post_logs_retry_limit
  attr_accessor :post_logs_retry_backoff
  attr_accessor :user_persistent_storage

  def initialize(
    environment = nil,
    download_config_specs_url: nil,
    log_event_url: nil,
    get_id_lists_url: nil,
    rulesets_sync_interval: 10,
    idlists_sync_interval: 60,
    disable_rulesets_sync: false,
    disable_idlists_sync: false,
    logging_interval_seconds: 60,
    logging_max_buffer_size: 1000,
    local_mode: false,
    bootstrap_values: nil,
    rules_updated_callback: nil,
    data_store: nil,
    idlist_threadpool_size: 3,
    logger_threadpool_size: 3,
    disable_diagnostics_logging: false,
    disable_sorbet_logging_handlers: false,
    network_timeout: nil,
    post_logs_retry_limit: 3,
    post_logs_retry_backoff: nil,
    user_persistent_storage: nil
  )
  end
end
```

### DataStore

```ruby
module Statsig
  module Interfaces
    class IDataStore
      def init
      end

      def get(key)
        nil
      end

      def set(key, value)
      end

      def shutdown
      end
    end
  end
end
```

