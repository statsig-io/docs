import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

## Usage

Since Next.js supports Server Side Rendering (SSR), we should setup Statsig to take advantage of this.

### Create layout.tsx

Let's start by creating a new route that our Statsig integration will live on. 
For the sake of this guide, we will call it `statsig-demo`.

Create the following `layout.tsx` file. This file will be responsible for the "Server" part of our SSR:

```tsx
// app/statsig-demo/layout.tsx

import { getStatsigValues } from "./StatsigHelpers"; // todo: Get values from statsig-node

// todo: Use values in @statsig/js-client
import BootstrappedStatsigProvider from "./BootstrappedStatsigProvider";
import { MY_STATSIG_CLIENT_KEY } from "./constants";

export default async function StatsigDemoLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  const user = { userID: "my-user" };
  const values = await getStatsigValues(user);

  return (
    <BootstrappedStatsigProvider
      clientSdkKey={MY_STATSIG_CLIENT_KEY}
      values={values}
      user={user}
    >
      {children}
    </BootstrappedStatsigProvider>
  );
}
```

This step assumes you have some file `constants.ts` that houses your keys, perhaps something like:

```tsx
export const MY_STATSIG_SERVER_KEY = process.env["statsig_server_key"]; // secret-***
export const MY_STATSIG_CLIENT_KEY = process.env["statsig_client_key"]; // client-***
```

If you run this now, you will get a bunch of errors related to the imports that do not yet exists. Lets create those next.


### Create getStatsigValues

`getStatsigValues` is the name of our helper function that generates the values required to "Bootstrap" our Statsig client.

Create this function in the following `StatsigHelpers.ts` file:

```tsx
// app/statsig-demo/StatsigHelpers.ts

import Statsig, { StatsigUser } from "statsig-node";
import { MY_STATSIG_CLIENT_KEY, MY_STATSIG_SERVER_KEY } from "./constants";

const isStatsigReady = Statsig.initialize(MY_STATSIG_SERVER_KEY); // <- Server Key

export async function getStatsigValues(user: StatsigUser): Promise<string> {
  await isStatsigReady;

  const values = Statsig.getClientInitializeResponse(
    user,
    MY_STATSIG_CLIENT_KEY, // <- Client Key
    {
      // !!! IMPORTANT - the @statsig/js-client requires djb2 hashed config names, and by default this method won't generate those
      hash: "djb2", 
    }
  );

  return JSON.stringify(values);
}
```

### Create BootstrappedStatsigProvider

Another requirement of our `layout.tsx` file was `BootstrappedStatsigProvider`. 

This component is the "Client" part of our SSR and requires the `"use client"` directive. 
It will be responsible for taking the values generated by `getStatsigValues` and using them to configure the Statsig client.

Create this component in the following `BootstrappedStatsigProvider.tsx` file:

```tsx
// app/statsig-demo/BootstrappedStatsigProvider.tsx

"use client";

import { useMemo, type PropsWithChildren } from "react";

import { StatsigClient, StatsigUser } from "@statsig/js-client";
import { StatsigProvider } from "@statsig/react-bindings";

type Props = PropsWithChildren & {
  readonly clientSdkKey: string;
  readonly user: StatsigUser;
  readonly values: string;
};

export default function BootstrappedStatsigProvider({
  clientSdkKey,
  user,
  values,
  children,
}: Props): JSX.Element {
  const client = useMemo(() => {
    const client = new StatsigClient(clientSdkKey, user);
    client.dataAdapter.setData(values);
    client.initializeSync();
    return client;
  }, [clientSdkKey, user, values]);

  return (
    <StatsigProvider client={client}>
      {children}
    </StatsigProvider>
  );
}
```

With the `BootstrappedStatsigProvider` created, we have now completed our `layout.tsx` file and will have access to
the Bootstrapped Statsig client in any child components that are rendered.

### Creating page.tsx

Now we can render a page and access our Statsig configurations.

Create the following `page.tsx` file:

```tsx
// app/statsig-demo/page.tsx

"use client";

import { useFeatureGate } from "@statsig/react-bindings";

export default function Home() {
  const gate = useFeatureGate("my_gate"); // Some gate created on console.statsig.com

  return (
    <>
      <h1>My Gate</h1>
      <p>Value: {gate.value ? "Pass" : "Fail"}</p>
      <p>Reason: {gate.details.reason}</p>
    </>
  );
}
```

### Result

Having created all the above files, we should now be able to load the demo page locally `http://localhost:3000/statsig-demo`
and see something like:

![statsig-demo-screenshot](https://github.com/statsig-io/js-client-monorepo/assets/95646168/8eb58f35-bf46-4550-bb0c-2142e1fb9bd3)


Our final file structure should be:
```
app/
└── statsig-demo/
|   ├── constants.ts
│   ├── page.tsx
│   ├── layout.tsx
│   ├── BootstrappedStatsigProvider.tsx
│   └── StatsigHelpers.ts
└── ...
```


This completes the basic Statsig integration into Next.js. You can stop here if all you needed was SSR, 
but we will now move onto more advanced topics around Proxying network request through your Next.js server.
