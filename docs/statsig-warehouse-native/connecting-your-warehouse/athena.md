---
title: Athena
slug: /statsig-warehouse-native/connecting-your-warehouse/athena
sidebar_label: Athena
---

:::info
Statsig Warehouse Native on Athena is in Beta. Some features available elsewhere (Custom Pulse Queries, Incremental Reloads and Metrics Explorer) are not available for this warehouse just yet but are coming soon.  
:::


## Overview

To set up connection with Athena, Statsig needs the following

- A Glue Database for staging
- An S3 Bucket (can be new or existing)
- An S3 Query Result Location (can be specified explicitly or as part of an Athena Workgroup)
- Athena Access Permissions (can be via an AWS Role or an AWS User)

## Grant Permissions to Statsig

You need to grant some permissions for Statsig from your AWS console in order for us to access your Athena data. Statsig requires
 - READ on any tables you are using for experimentation
 - USAGE/WRITE on a Statsig-specific Schema we'll use to materialize temp tables and results. This enables us to cache data and perform incremental loads. 


1. Create an (**A**) IAM Role, or (**B**) IAM User

   (**A**) IAM Role
   With an IAM Role, Statsig will assume your created IAM Role via a Statsig Service Account. The ARN for this service account is provided in your Data Connection settings in the Statsig Console. Statsig will run queries directly on behalf of this IAM Role. Optionally, you can add an External ID condition for added security ([AWS External ID Docs](https://aws.amazon.com/blogs/security/how-to-use-external-id-when-granting-access-to-your-aws-resources/)). This External ID will be generated by Statsig, and viewable in your Data Connection settings in the Statsig Console.
      - In your AWS IAM Dashboard, select the Roles page under the Access Management tab
      - Create a new Role
      - Under the Trust Relationships tab of this newly created Role, edit the trust policy to include the Assume Role action for the provided Statsig Service Account.
        ```
        {
           "Version": "2012-10-17",
           "Statement": [
              {
                 "Effect": "Allow",
                 "Principal": {
                    "AWS": "<STATSIG_SERVICE_ACCOUNT>"
                 },
                 "Action": "sts:AssumeRole",
                 "Condition": {
                    "StringEquals": {
                       "sts:ExternalId": "<ROLE_EXTERNAL_ID>"
                    }
                 }
              }
           ]
        }
        ```
      - Add the ARN for this IAM Role into the Data Connection setup in the Statsig console

   (**B**) IAM User
   With an IAM User, Statsig will use AWS Access Keys to gain access to this IAM User. Statsig will run queries directly on behalf of this IAM User.
      - In your AWS IAM Dashboard, select the Users page under the Access Management tab
      - Create a new User
      - Under the Security Credentials tab of this newly created User, find the Access Keys block
      - Select Create Access Key, and choose 'Application running outside AWS' from the Use Case options
   ![image](https://github.com/statsig-io/docs/assets/152932686/c0f762fe-2963-45ca-9424-5399671d53e5)
      - Add the Access Key and Secret Access Key into the Data Connection setup in the Statsig console

2. Under the Permissions tab for your newly created Role/User, add the Permission Policies outlined below:
   ```
   {
      "Version": "2012-10-17",
      "Statement": [
         {
            "Effect": "Allow",
            "Action": [
               "s3:ListBucket",
               "s3:GetBucketLocation",
               "s3:GetObject",
               "s3:PutObject",
               "s3:DeleteObject"
            ],
            "Resource": "arn:aws:s3:::<S3_BUCKET>"
         },
         {
            "Effect": "Allow",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::<S3_BUCKET>/<PATH_TO_EVENTS_AND_EXPOSURES_DATA>/*"
         },
         {
            "Effect": "Allow",
            "Action": [
               "glue:GetTable",
               "glue:GetDatabase",
               "glue:GetPartition",
               "glue:GetPartitions"
            ],
            "Resource": [
               "arn:aws:glue:<REGION>:<ACCOUNT_ID>:database/<EVENTS_AND_EXPOSURES_DATABASE>",
               "arn:aws:glue:<REGION>:<ACCOUNT_ID>:table/<EVENTS_AND_EXPOSURES_DATABASE>/*"
            ]
         },
         {
            "Effect": "Allow",
            "Action": [
               "s3:GetObject",
               "s3:PutObject",
               "s3:DeleteObject",
               "athena:StartQueryExecution",
               "athena:GetQueryResults",
               "athena:GetQueryExecution",
               "glue:GetTable",
               "glue:CreateTable",
               "glue:UpdateTable",
               "glue:DeleteTable",
               "glue:GetPartition",
               "glue:GetPartitions",
               "glue:CreatePartition",
               "glue:UpdatePartition",
               "glue:DeletePartition",
               "glue:BatchCreatePartition",
               "glue:BatchDeletePartition",
               "glue:GetDatabase"
            ],
            "Resource": [
               "arn:aws:s3:::<S3_BUCKET>/<PATH_TO_QUERY_RESULTS_FOLDER>/*",
               "arn:aws:s3:::<S3_BUCKET>/<STATSIG_S3_FOLDER>/*",
               "arn:aws:athena:<REGION>:<ACCOUNT_ID>:workgroup/<ATHENA_WORKGROUP>",
               "arn:aws:glue:<REGION>:<ACCOUNT_ID>:catalog",
               "arn:aws:glue:<REGION>:<ACCOUNT_ID>:database/<GLUE_STAGING_DATABASE>",
               "arn:aws:glue:<REGION>:<ACCOUNT_ID>:table/<GLUE_STAGING_DATABASE>/*"
            ]
         }
      ]
   }
   ```

## Setup Athena Query Flow

1. Create or choose a Glue Database (can be `default`). Statsig will use this as a staging Database to manage created tables.

2. Choose an S3 Query Result Location folder. This S3 location will act as the Output Location for queries run in your Athena Warehouse. This Location can be given either:
   - Explicitly as an S3 location (ex: `s3://my_bucket/my_query_results_folder/`)
   - OR as part of a setting within an Athena Workgroup

3. Specify your AWS Organization region. It is expected that all of your AWS resources in Athena/Glue exist under 1 region.

### What IP addresses will Statsig access data warehouses from?

[See FAQ](/data-warehouse-ingestion/faq#what-ip-addresses-will-statsig-access-data-warehouses-from)
