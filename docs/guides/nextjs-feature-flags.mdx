---
sidebar_label: How to set up Feature Flags with Next.js (App Router)
title: How to set up Feature Flags with Next.js (App Router)
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

Next.js is an open-source React framework for building fast and user-friendly full-stack web applications.

In this tutorial we'll integrate our [React Client SDK](https://docs.statsig.com/client/reactSDK) and [NodeJS Server SDK](https://docs.statsig.com/server/nodejsServerSDK) into a simple Next.js app with App Router and check a feature gate to determine if the end user should see a new feature. 

## Create a Feature Gate in Statsig

Create a Statsig account and obtain an SDK key: [Signup for free](https://www.statsig.com/signup)!

The below command can be run to automatically create the simple `nextjs_app_bg` gate in Statsig that gets used throughout this integration guide and demo app. The gate randomizes based on `userID` and has a 50/50 allocation. Make sure to replace the authorization key in the header with your key generated in Statsig project settings as documented [here](https://docs.statsig.com/console-api/introduction).
```bash
curl --request POST 'https://statsigapi.net/console/v1/gates' \
--header 'STATSIG-API-KEY: console-REPLACE_WITH_YOURS' \
--header 'Content-Type: application/json' \
--data-raw '{"name":"nextjs_app_bg","idType":"userID","isEnabled":true,"rules":[{"name":"Everyone","passPercentage":50,"conditions":[{"type":"public"}]}]}'
``` 
![image](/img/nextjs-gate.png)
![image](/img/nextjs-rule.png)

## Setup a Next.js app

Create a Next.js app by running the following command, and using the default options:

```
npx create-next-app@latest
```

This will create a Next.js app in a folder with the name of your app (default my-app). Run the following commands to run the app:

```
cd my-app
npm run dev
```

You should see the following app in your localhost:

![image](/img/nextjs-app.png)

## Setup the Statsig React SDK on the client side

First install the Statsig [React SDK](https://docs.statsig.com/server/Node.jsServerSDK)

<Tabs
  defaultValue="npm"
  values={[
    {label: 'NPM', value: 'npm'},
    {label: 'Yarn', value: 'yarn'},
  ]}>
  <TabItem value="npm">

```shell
npm install statsig-react
```

  </TabItem>
  <TabItem value="yarn">

```shell
yarn add statsig-react
```

  </TabItem>
</Tabs>

And add your Statsig Client API key (available in your Project Settings) to an env variable in `.env.local` and to your hosting provider (e.g. Vercel, Netlify). Prefix the env variable with `NEXT_PUBLIC_` so that the client SDK will be bundled to the browser.

```
NEXT_PUBLIC_STATSIG_CLIENT_KEY=client-voEIZ0rGAYGBugJ6vONHN23YNuqYrExm2TMPpTiDZfi
```

Since app router using server components by default, and the Statsig React SDK is a client side package, we'll need to wrap the React SDK as described in NextJS docs [here](https://nextjs.org/docs/app/building-your-application/rendering/composition-patterns#using-third-party-packages-and-providers)

```
// app/statsig-provider.tsx
'use client'

import { StatsigProvider as Provider, StatsigUser } from "statsig-react";

export function StatsigProvider({ children, user }: {
    children: React.ReactNode,
    user: StatsigUser,
  }) {
    return (
      <Provider
        sdkKey={process.env.NEXT_PUBLIC_STATSIG_CLIENT_KEY!}
        waitForInitialization={true}
        user={user}
      >
        {children}
      </Provider>
    );
  }
```

We'll now be able to import the statsig-provider.tsx file in our app/layout.tsx file, and wrap our app in a StatsigProvider

```
// app/layout.tsx

import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";

import { StatsigProvider } from "./statsig-provider";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  const user = { userID: "123" }; // Get the user from your app
  return (
    <html lang="en">
      <body className={inter.className}>
        <StatsigProvider user={user}>
          {children}
        </StatsigProvider>
      </body>
    </html>
  );
}

```

## Checking Feature Gates on the Client

Now that we have the SDK set up on the client side, we can check feature gates. 

To do this, create a new page under the `background/page.tsx` file in the app folder that checks the `nextjs_app_bg` gate we created earlier.

```
// app/background/page.tsx
'use client'

import { useGate } from "statsig-react";

export default function Background() {

    const { value } = useGate("nextjs_app_bg");
    
    return (
        <div style={value ? {background: "#194B7D"} : {}}>
        <h1>Statsig Sample Nextjs App</h1>
        <h3>
            {value ? "Passing nextjs_app_bg gate (Blue Background)" : "Failing nextjs_app_bg gate (Black Background)"}
        </h3>
        </div>
    );
}
```

You'll now be bucketed either into the gate or not and get a corresponding experience. 

Passing Experience:
![image](/img/nextjs-pass.png)

Failing Experience: 
![image](/img/nextjs-fail.png)

## Using Server Side Rendering to Improve Performance

To improve performance for the client side feature gates check pattern, we can evaluate feature flag values on the server and pass results to the client. 

Create a `statsig-synchronous-provider.tsx` file to wrap the StatsigSynchronousProvider component from the React SDK.

```
// app/statsig-synchronous-provider.tsx

'use client'

import { StatsigSynchronousProvider as Provider, StatsigUser } from 'statsig-react';

export function StatsigSynchronousProvider({ children, initializeValues, user }: {
    children: React.ReactNode,
    user: StatsigUser,
    initializeValues: Record<string, any>
  }) {
    return (
      <Provider
        sdkKey={process.env.NEXT_PUBLIC_STATSIG_CLIENT_KEY!}
        initializeValues={initializeValues}
        user={user}
      >
        {children}
      </Provider>
    );
  }
```

Now in our RootLayout, we can evaluate Statsig configs for a user on the server side, and pass the results to the StatsigSynchronousProvider. This will avoid a round-trip to Statsig for gate evaluation results, and avoiding flicker when loading webpages. 

```
// app/layout.tsx

...
import { StatsigProvider } from "./statsig-provider";
import { StatsigSynchronousProvider } from "./statsig-synchronous-provider";
...

async function getStatsigInitializeResponse(user: StatsigUser) {
  await Statsig.initialize(process.env.STATSIG_SERVER_SECRET!);
  return Statsig.getClientInitializeResponse(user);
}

export default async function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  const user = { userID: "123" }; // Get the user from your app
  const data = await getStatsigInitializeResponse(user);

  return (
    <html lang="en">
        <body className={inter.className}>
          {data ? 
            <StatsigSynchronousProvider initializeValues={data} user={user}>
              {children}
            </StatsigSynchronousProvider> :
            <StatsigProvider user={user}>
              {children}
            </StatsigProvider>
          }
        </body>
    </html>
  );
}
```